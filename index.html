<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Constructor de Rutas de Aprendizaje - Vista Diagrama</title>
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f8f9fa;
      padding: 20px;
      margin: 0;
      overflow: hidden;
    }
    .container {
      max-width: 100%;
      margin: 0 auto;
      height: calc(100vh - 40px);
      display: flex;
      flex-direction: column;
    }
    header {
      text-align: center;
      margin-bottom: 20px;
    }
    h1 {
      color: #2c3e50;
      margin-bottom: 10px;
    }
    .view-controls {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-bottom: 20px;
    }
    .btn {
      padding: 10px 16px;
      background: #3498db;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
      transition: background 0.2s;
    }
    .btn:hover {
      background: #2980b9;
    }
    .btn-active {
      background: #2c3e50;
    }
    .btn-start { background: #2ecc71; }
    .btn-start:hover { background: #27ae60; }
    .btn-end { background: #e74c3c; }
    .btn-end:hover { background: #c0392b; }
    .btn-import { background: #9b59b6; }
    .btn-import:hover { background: #8e44ad; }
    .btn-export { background: #f39c12; }
    .btn-export:hover { background: #d35400; }
    
    /* Vista de Diagrama */
    .diagram-view {
      position: relative;
      flex: 1;
      background: #f8f9fa;
      border-radius: 10px;
      border: 2px dashed #e9ecef;
      overflow: hidden;
      cursor: grab;
    }
    
    .diagram-view:active {
      cursor: grabbing;
    }
    
    .connections {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
    }
    
    .nodes-grid {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }
    
    .node-circle {
      position: absolute;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      color: white;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      transition: all 0.3s ease;
      z-index: 10;
      user-select: none;
    }
    
    .node-circle:hover {
      transform: scale(1.1);
      box-shadow: 0 6px 20px rgba(0,0,0,0.2);
    }
    
    .node-circle.start { background: #2ecc71; }
    .node-circle.intermediate { background: #3498db; }
    .node-circle.end { background: #e74c3c; }
    
    .node-badge {
      font-size: 1.2em;
    }
    
    /* Panel de Informaci√≥n */
    .info-panel {
      position: fixed;
      right: -400px;
      top: 0;
      width: 380px;
      height: 100vh;
      background: white;
      box-shadow: -5px 0 15px rgba(0,0,0,0.1);
      transition: right 0.3s ease;
      z-index: 1000;
      overflow-y: auto;
      padding-bottom: 20px;
    }
    
    .info-panel.open {
      right: 0;
    }
    
    .panel-header {
      padding: 20px;
      border-bottom: 1px solid #eee;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #f8f9fa;
    }
    
    .btn-close-panel {
      background: none;
      border: none;
      font-size: 1.5em;
      cursor: pointer;
      color: #7f8c8d;
    }
    
    .panel-content {
      padding: 20px;
    }
    
    .node-title-input {
      width: 100%;
      padding: 10px;
      font-size: 1.2em;
      border: 1px solid #ddd;
      border-radius: 4px;
      margin-bottom: 15px;
    }
    
    .node-comment-input {
      width: 100%;
      padding: 8px;
      border: 1px dashed #ddd;
      border-radius: 4px;
      font-style: italic;
      color: #7f8c8d;
      margin-bottom: 15px;
      resize: vertical;
      min-height: 60px;
    }
    
    .topics-list {
      margin: 15px 0;
    }
    
    .topic-item {
      display: flex;
      align-items: center;
      margin: 8px 0;
      padding: 8px;
      border-radius: 4px;
      transition: background 0.2s;
      border: 1px solid #eee;
    }
    
    .topic-item:hover {
      background: #f8f9fa;
    }
    
    .topic-input {
      flex: 1;
      padding: 6px;
      border: 1px solid #ddd;
      border-radius: 4px;
      margin: 0 10px;
    }
    
    .topic-checkbox {
      transform: scale(1.2);
    }
    
    .topic-actions {
      display: flex;
      gap: 5px;
    }
    
    .topic-actions button {
      padding: 4px 8px;
      background: #f1f1f1;
      border: 1px solid #ddd;
      border-radius: 4px;
      cursor: pointer;
    }
    
    .add-topic-btn {
      background: #3498db;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 4px;
      cursor: pointer;
      margin-top: 10px;
      width: 100%;
    }
    
    .panel-actions {
      margin-top: 20px;
      display: flex;
      gap: 10px;
    }
    
    .panel-actions button {
      padding: 8px 12px;
      background: #ecf0f1;
      border: 1px solid #bdc3c7;
      border-radius: 4px;
      cursor: pointer;
    }
    
    .progress-container {
      background: white;
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 20px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.1);
    }
    
    .progress-bar {
      height: 10px;
      background: #ecf0f1;
      border-radius: 5px;
      margin: 10px 0;
      overflow: hidden;
    }
    
    .progress-fill {
      height: 100%;
      background: #2ecc71;
      transition: width 0.3s;
    }
    
    .progress-text {
      display: flex;
      justify-content: space-between;
      font-size: 0.9em;
      color: #7f8c8d;
    }
    
    .controls {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    
    .modal-content {
      background: white;
      border-radius: 10px;
      padding: 20px;
      width: 90%;
      max-width: 600px;
      max-height: 80vh;
      overflow-y: auto;
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    
    .close-modal {
      background: none;
      border: none;
      font-size: 1.5em;
      cursor: pointer;
    }
    
    .import-textarea {
      width: 100%;
      height: 300px;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-family: monospace;
      resize: vertical;
    }
    
    .node-circle.selected {
      box-shadow: 0 0 0 3px #f39c12;
    }
    
    .empty-diagram {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: #7f8c8d;
      text-align: center;
    }
    
    .empty-diagram h3 {
      margin-bottom: 10px;
    }
    
    /* Vista de Lista (oculta inicialmente) */
    .list-view {
      display: none;
      position: relative;
      min-height: 300px;
    }
    
    .roadmap-line {
      position: absolute;
      left: 50px;
      top: 0;
      bottom: 0;
      width: 4px;
      background: #3498db;
      z-index: 0;
    }
    
    .nodes {
      display: flex;
      flex-direction: column;
      gap: 30px;
      position: relative;
      z-index: 1;
    }
    
    .node {
      background: white;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.1);
      margin-left: 70px;
      position: relative;
      max-width: 700px;
      border-left: 5px solid #95a5a6;
    }
    
    .node.start {
      border-left-color: #2ecc71;
    }
    
    .node.intermediate {
      border-left-color: #3498db;
    }
    
    .node.end {
      border-left-color: #e74c3c;
    }
    
    .node::before {
      content: '';
      position: absolute;
      left: -60px;
      top: 50%;
      transform: translateY(-50%);
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: #95a5a6;
      border: 3px solid white;
      box-shadow: 0 0 0 3px #95a5a6;
    }
    
    .node.start::before { 
      background: #2ecc71;
      box-shadow: 0 0 0 3px #2ecc71;
    }
    
    .node.intermediate::before { 
      background: #3498db;
      box-shadow: 0 0 0 3px #3498db;
    }
    
    .node.end::before { 
      background: #e74c3c;
      box-shadow: 0 0 0 3px #e74c3c;
    }
    
    .validation-error {
      color: #e74c3c;
      font-size: 0.9em;
      margin-top: 5px;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>üõ†Ô∏è Constructor de Rutas de Aprendizaje</h1>
      <p>Crea tu propia quest de aprendizaje: visualiza nodos, edita temas y marca tu progreso</p>
    </header>

    <div class="progress-container">
      <h3>Progreso de la Ruta</h3>
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill" style="width: 0%"></div>
      </div>
      <div class="progress-text">
        <span id="completedCount">0 completados</span>
        <span id="totalCount">0 total</span>
        <span id="progressPercentage">0%</span>
      </div>
    </div>

    <div class="view-controls">
      <button class="btn btn-active" id="btnDiagramView" onclick="switchView('diagram')">üîµ Vista Diagrama</button>
      <button class="btn" id="btnListView" onclick="switchView('list')">üìã Vista Lista</button>
    </div>

    <div class="controls">
      <button class="btn btn-start" onclick="addNode('start')">+ Inicio</button>
      <button class="btn" onclick="addNode('intermediate')">+ Paso Intermedio</button>
      <button class="btn btn-end" onclick="addNode('end')">+ Final</button>
      <button class="btn btn-import" onclick="showImportModal()">üì• Importar</button>
      <button class="btn btn-export" onclick="exportRoadmap()">üì§ Exportar</button>
      <button class="btn" onclick="validateRoadmap()">‚úÖ Validar</button>
    </div>

    <!-- Vista de Diagrama -->
    <div class="diagram-view" id="diagramView">
      <svg class="connections" id="connectionsCanvas"></svg>
      <div class="nodes-grid" id="nodesGrid">
        <div class="empty-diagram" id="emptyDiagram">
          <h3>¬°Comienza agregando tu primer nodo!</h3>
          <p>Usa los botones de arriba para agregar nodos de inicio, intermedios o finales</p>
        </div>
      </div>
    </div>

    <!-- Vista de Lista (oculta inicialmente) -->
    <div class="list-view" id="listView">
      <div class="roadmap-line"></div>
      <div class="nodes" id="nodesContainer">
        <div class="empty-state" id="emptyState">
          <p>¬°Comienza agregando tu primer nodo!</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Panel de Informaci√≥n -->
  <div class="info-panel" id="infoPanel">
    <div class="panel-header">
      <h3 id="panelTitle">Detalles del Nodo</h3>
      <button class="btn-close-panel" onclick="closeInfoPanel()">√ó</button>
    </div>
    <div class="panel-content" id="panelContent">
      <!-- El contenido se carga din√°micamente -->
    </div>
  </div>

  <!-- Modal para importar -->
  <div class="modal" id="importModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Importar Ruta</h2>
        <button class="close-modal" onclick="closeImportModal()">&times;</button>
      </div>
      <p>Pega tu ruta en formato de texto usando la sintaxis:</p>
      <ul>
        <li><strong>+</strong> para nodos de inicio/final</li>
        <li><strong>-</strong> para nodos intermedios</li>
        <li><strong>--</strong> para temas con checklist</li>
        <li><strong>#</strong> para comentarios o t√≠tulos</li>
        <li><strong>!</strong> para conexiones entre puntos</li>
      </ul>
      <textarea class="import-textarea" id="importTextarea" placeholder="Ejemplo:
+ Inicio
! # el usuario deber√° investigar alguna introducci√≥n al an√°lisis de datos
!- 1. SQL
! -- introducci√≥n a sql y su sintaxis
! -- aprender sobre joins
!- 2. Python para an√°lisis de datos
! -- aprender sintaxis b√°sica de python
+ Listo haberes un analista de datos"></textarea>
      <div class="node-actions" style="margin-top: 15px;">
        <button class="btn" onclick="importRoadmap()">Importar</button>
        <button class="btn" onclick="closeImportModal()">Cancelar</button>
      </div>
    </div>
  </div>

  <script>
  // Estado inicial
  let roadmap = JSON.parse(localStorage.getItem('customRoadmap')) || [];
  let currentView = 'diagram';
  let selectedNodeIndex = null;
  let diagramOffset = { x: 0, y: 0 };
  let isDraggingDiagram = false;
  let dragStart = { x: 0, y: 0 };

  // Inicializaci√≥n
  document.addEventListener('DOMContentLoaded', () => {
    renderDiagram();
    setupDiagramPanning();
    
    // Cargar datos de ejemplo si no hay nada
    if (roadmap.length === 0) {
      loadSampleData();
    }
  });

  // Configurar el arrastre del diagrama
  function setupDiagramPanning() {
    const diagram = document.getElementById('diagramView');
    
    diagram.addEventListener('mousedown', (e) => {
      if (e.target === diagram) {
        isDraggingDiagram = true;
        dragStart.x = e.clientX - diagramOffset.x;
        dragStart.y = e.clientY - diagramOffset.y;
        diagram.style.cursor = 'grabbing';
      }
    });
    
    document.addEventListener('mousemove', (e) => {
      if (!isDraggingDiagram) return;
      
      diagramOffset.x = e.clientX - dragStart.x;
      diagramOffset.y = e.clientY - dragStart.y;
      
      const nodesGrid = document.getElementById('nodesGrid');
      nodesGrid.style.transform = `translate(${diagramOffset.x}px, ${diagramOffset.y}px)`;
      
      drawConnections();
    });
    
    document.addEventListener('mouseup', () => {
      isDraggingDiagram = false;
      diagram.style.cursor = 'grab';
    });
  }

  // Cambiar entre vistas
  function switchView(view) {
    currentView = view;
    
    // Actualizar botones
    document.getElementById('btnDiagramView').classList.toggle('btn-active', view === 'diagram');
    document.getElementById('btnListView').classList.toggle('btn-active', view === 'list');
    
    // Mostrar/ocultar vistas
    document.getElementById('diagramView').style.display = view === 'diagram' ? 'block' : 'none';
    document.getElementById('listView').style.display = view === 'list' ? 'block' : 'none';
    
    // Renderizar la vista correspondiente
    if (view === 'diagram') {
      renderDiagram();
    } else {
      renderList();
    }
  }

  // Guardar en localStorage
  function saveRoadmap() {
    localStorage.setItem('customRoadmap', JSON.stringify(roadmap));
    updateProgress();
  }

  // Renderizar el diagrama
  function renderDiagram() {
    const container = document.getElementById('nodesGrid');
    const emptyDiagram = document.getElementById('emptyDiagram');
    
    if (!container || !emptyDiagram) return;
    
    if (roadmap.length === 0) {
      emptyDiagram.style.display = 'flex';
      container.innerHTML = '';
      return;
    }
    
    emptyDiagram.style.display = 'none';
    container.innerHTML = '';
    
    roadmap.forEach((node, index) => {
      const nodeEl = document.createElement('div');
      nodeEl.className = `node-circle ${node.type}`;
      nodeEl.dataset.nodeId = index;
      
      // Posici√≥n autom√°tica o usar posici√≥n guardada
      const position = node.position || calculateNodePosition(index, roadmap.length);
      nodeEl.style.left = `${position.x}px`;
      nodeEl.style.top = `${position.y}px`;
      
      nodeEl.innerHTML = `<span class="node-badge">${index + 1}</span>`;
      nodeEl.addEventListener('click', (e) => {
        e.stopPropagation();
        selectNode(index);
        showNodeInfo(index);
      });
      
      // Hacer nodos arrastrables
      makeNodeDraggable(nodeEl, index);
      
      container.appendChild(nodeEl);
    });
    
    drawConnections();
    updateProgress();
  }

  // Calcular posici√≥n autom√°tica para los nodos
  function calculateNodePosition(index, total) {
    // Distribuci√≥n en espiral para mejor visualizaci√≥n
    const angle = (index / total) * Math.PI * 2;
    const radius = Math.min(150 + (index * 20), 250);
    return {
      x: 400 + Math.cos(angle) * radius,
      y: 300 + Math.sin(angle) * radius
    };
  }

  // Hacer nodos arrastrables
  function makeNodeDraggable(nodeElement, nodeIndex) {
    let isDragging = false;
    let startX, startY, initialLeft, initialTop;
    
    nodeElement.addEventListener('mousedown', startDrag);
    
    function startDrag(e) {
      isDragging = true;
      startX = e.clientX;
      startY = e.clientY;
      initialLeft = parseInt(nodeElement.style.left);
      initialTop = parseInt(nodeElement.style.top);
      
      document.addEventListener('mousemove', drag);
      document.addEventListener('mouseup', stopDrag);
      e.stopPropagation();
    }
    
    function drag(e) {
      if (!isDragging) return;
      
      const dx = e.clientX - startX;
      const dy = e.clientY - startY;
      
      nodeElement.style.left = `${initialLeft + dx}px`;
      nodeElement.style.top = `${initialTop + dy}px`;
      
      // Actualizar posici√≥n en datos
      roadmap[nodeIndex].position = {
        x: initialLeft + dx,
        y: initialTop + dy
      };
      
      drawConnections();
    }
    
    function stopDrag() {
      isDragging = false;
      document.removeEventListener('mousemove', drag);
      document.removeEventListener('mouseup', stopDrag);
      saveRoadmap();
    }
  }

  // Dibujar conexiones entre nodos
  function drawConnections() {
    const svg = document.getElementById('connectionsCanvas');
    svg.innerHTML = '';
    
    // Dibujar l√≠neas entre nodos en orden
    for (let i = 0; i < roadmap.length - 1; i++) {
      const currentEl = document.querySelector(`[data-node-id="${i}"]`);
      const nextEl = document.querySelector(`[data-node-id="${i + 1}"]`);
      
      if (currentEl && nextEl) {
        const rect1 = currentEl.getBoundingClientRect();
        const rect2 = nextEl.getBoundingClientRect();
        const containerRect = svg.getBoundingClientRect();
        
        const x1 = rect1.left + rect1.width/2 - containerRect.left;
        const y1 = rect1.top + rect1.height/2 - containerRect.top;
        const x2 = rect2.left + rect2.width/2 - containerRect.left;
        const y2 = rect2.top + rect2.height/2 - containerRect.top;
        
        const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        line.setAttribute('x1', x1);
        line.setAttribute('y1', y1);
        line.setAttribute('x2', x2);
        line.setAttribute('y2', y2);
        line.setAttribute('stroke', '#3498db');
        line.setAttribute('stroke-width', '3');
        line.setAttribute('stroke-dasharray', '5,5');
        
        svg.appendChild(line);
      }
    }
  }

  // Seleccionar un nodo
  function selectNode(nodeIndex) {
    // Deseleccionar nodo anterior
    if (selectedNodeIndex !== null) {
      const prevNode = document.querySelector(`[data-node-id="${selectedNodeIndex}"]`);
      if (prevNode) prevNode.classList.remove('selected');
    }
    
    // Seleccionar nuevo nodo
    selectedNodeIndex = nodeIndex;
    const currentNode = document.querySelector(`[data-node-id="${nodeIndex}"]`);
    if (currentNode) currentNode.classList.add('selected');
  }

  // Mostrar informaci√≥n del nodo en el panel
  function showNodeInfo(nodeIndex) {
    const panel = document.getElementById('infoPanel');
    const content = document.getElementById('panelContent');
    
    // Cargar informaci√≥n del nodo en el panel
    const node = roadmap[nodeIndex];
    content.innerHTML = `
      <input type="text" class="node-title-input" value="${node.title}" 
             onblur="updateNodeTitle(${nodeIndex}, this.value)" placeholder="T√≠tulo del nodo">
      <textarea class="node-comment-input" placeholder="Agregar comentario (opcional)" 
                onblur="updateNodeComment(${nodeIndex}, this.value)">${node.comment || ''}</textarea>
      
      <div class="topics-list">
        ${node.topics.map((topic, tIndex) => `
          <div class="topic-item">
            <input type="checkbox" class="topic-checkbox" ${topic.completed ? 'checked' : ''}
                   onchange="toggleTopicCompletion(${nodeIndex}, ${tIndex})">
            <input type="text" class="topic-input" value="${topic.text}"
                   onblur="updateTopicText(${nodeIndex}, ${tIndex}, this.value)">
            <div class="topic-actions">
              <button onclick="moveTopicUp(${nodeIndex}, ${tIndex})">‚¨ÜÔ∏è</button>
              <button onclick="moveTopicDown(${nodeIndex}, ${tIndex})">‚¨áÔ∏è</button>
              <button onclick="removeTopic(${nodeIndex}, ${tIndex})">üóëÔ∏è</button>
            </div>
          </div>
        `).join('')}
      </div>
      
      <button class="add-topic-btn" onclick="addTopic(${nodeIndex})">+ A√±adir tema</button>
      
      <div class="panel-actions">
        <button onclick="moveNodeUp(${nodeIndex})">‚¨ÜÔ∏è Subir</button>
        <button onclick="moveNodeDown(${nodeIndex})">‚¨áÔ∏è Bajar</button>
        <button onclick="removeNode(${nodeIndex})">üóëÔ∏è Eliminar</button>
      </div>
    `;
    
    document.getElementById('panelTitle').textContent = `Nodo ${nodeIndex + 1}: ${node.title}`;
    panel.classList.add('open');
  }

  // Cerrar panel de informaci√≥n
  function closeInfoPanel() {
    document.getElementById('infoPanel').classList.remove('open');
    saveRoadmap();
    
    // Actualizar la vista actual
    if (currentView === 'diagram') {
      renderDiagram();
    } else {
      renderList();
    }
  }

  // Renderizar la vista de lista
  function renderList() {
    const container = document.getElementById('nodesContainer');
    const emptyState = document.getElementById('emptyState');
    
    if (!container || !emptyState) return;
    
    if (roadmap.length === 0) {
      emptyState.style.display = 'block';
      container.innerHTML = '';
      return;
    }
    
    emptyState.style.display = 'none';
    container.innerHTML = '';
    
    roadmap.forEach((node, index) => {
      const nodeEl = document.createElement('div');
      nodeEl.className = `node ${node.type}`;
      nodeEl.dataset.index = index;
      
      // T√≠tulo editable
      const titleEl = document.createElement('div');
      titleEl.className = 'node-title';
      titleEl.innerHTML = `
        <input type="text" class="node-title-input" value="${node.title}" 
               onblur="updateNodeTitle(${index}, this.value)">
      `;
      
      // Comentario editable
      const commentEl = document.createElement('div');
      commentEl.className = 'node-comment';
      commentEl.innerHTML = `
        <input type="text" class="node-comment-input" value="${node.comment || ''}" 
               placeholder="Agregar comentario (opcional)" 
               onblur="updateNodeComment(${index}, this.value)">
      `;
      
      // Lista de temas
      const topicsEl = document.createElement('div');
      topicsEl.className = 'topics-list';
      
      node.topics.forEach((topic, tIndex) => {
        const topicEl = document.createElement('div');
        topicEl.className = 'topic-item';
        topicEl.innerHTML = `
          <input type="checkbox" class="topic-checkbox" ${topic.completed ? 'checked' : ''}
                 onchange="toggleTopicCompletion(${index}, ${tIndex})">
          <input type="text" class="topic-input" value="${topic.text}"
                 onblur="updateTopicText(${index}, ${tIndex}, this.value)">
          <div class="topic-actions">
            <button onclick="moveTopicUp(${index}, ${tIndex})">‚¨ÜÔ∏è</button>
            <button onclick="moveTopicDown(${index}, ${tIndex})">‚¨áÔ∏è</button>
            <button onclick="removeTopic(${index}, ${tIndex})">üóëÔ∏è</button>
          </div>
        `;
        topicsEl.appendChild(topicEl);
      });
      
      // Bot√≥n para a√±adir tema
      const addTopicBtn = document.createElement('button');
      addTopicBtn.className = 'add-topic-btn';
      addTopicBtn.textContent = '+ A√±adir tema';
      addTopicBtn.onclick = () => addTopic(index);
      
      // Acciones del nodo
      const actionsEl = document.createElement('div');
      actionsEl.className = 'node-actions';
      actionsEl.innerHTML = `
        <button onclick="moveNodeUp(${index})">‚¨ÜÔ∏è Subir</button>
        <button onclick="moveNodeDown(${index})">‚¨áÔ∏è Bajar</button>
        <button onclick="removeNode(${index})">üóëÔ∏è Eliminar</button>
      `;
      
      nodeEl.appendChild(titleEl);
      nodeEl.appendChild(commentEl);
      nodeEl.appendChild(topicsEl);
      nodeEl.appendChild(addTopicBtn);
      nodeEl.appendChild(actionsEl);
      
      container.appendChild(nodeEl);
    });
    
    updateProgress();
  }

  // Actualizar progreso
  function updateProgress() {
    let totalTopics = 0;
    let completedTopics = 0;
    
    roadmap.forEach(node => {
      totalTopics += node.topics.length;
      completedTopics += node.topics.filter(topic => topic.completed).length;
    });
    
    const percentage = totalTopics > 0 ? Math.round((completedTopics / totalTopics) * 100) : 0;
    
    document.getElementById('progressFill').style.width = `${percentage}%`;
    document.getElementById('completedCount').textContent = `${completedTopics} completados`;
    document.getElementById('totalCount').textContent = `${totalTopics} total`;
    document.getElementById('progressPercentage').textContent = `${percentage}%`;
  }

  // A√±adir nodo
  function addNode(type) {
    const defaultTitles = {
      start: 'Inicio: Mi Objetivo',
      intermediate: 'Paso Intermedio',
      end: '¬°Logrado!'
    };
    
    roadmap.push({
      type: type,
      title: defaultTitles[type],
      comment: '',
      topics: []
    });
    
    saveRoadmap();
    
    if (currentView === 'diagram') {
      renderDiagram();
    } else {
      renderList();
    }
  }

  // A√±adir tema
  function addTopic(nodeIndex) {
    roadmap[nodeIndex].topics.push({
      text: 'Nuevo tema',
      completed: false
    });
    saveRoadmap();
    
    // Actualizar panel si est√° abierto
    if (document.getElementById('infoPanel').classList.contains('open') && selectedNodeIndex === nodeIndex) {
      showNodeInfo(nodeIndex);
    }
  }

  // Eliminar tema
  function removeTopic(nodeIndex, topicIndex) {
    roadmap[nodeIndex].topics.splice(topicIndex, 1);
    saveRoadmap();
    
    // Actualizar panel si est√° abierto
    if (document.getElementById('infoPanel').classList.contains('open') && selectedNodeIndex === nodeIndex) {
      showNodeInfo(nodeIndex);
    }
  }

  // Mover tema hacia arriba
  function moveTopicUp(nodeIndex, topicIndex) {
    if (topicIndex === 0) return;
    const topics = roadmap[nodeIndex].topics;
    [topics[topicIndex], topics[topicIndex - 1]] = [topics[topicIndex - 1], topics[topicIndex]];
    saveRoadmap();
    
    // Actualizar panel si est√° abierto
    if (document.getElementById('infoPanel').classList.contains('open') && selectedNodeIndex === nodeIndex) {
      showNodeInfo(nodeIndex);
    }
  }

  // Mover tema hacia abajo
  function moveTopicDown(nodeIndex, topicIndex) {
    const topics = roadmap[nodeIndex].topics;
    if (topicIndex === topics.length - 1) return;
    [topics[topicIndex], topics[topicIndex + 1]] = [topics[topicIndex + 1], topics[topicIndex]];
    saveRoadmap();
    
    // Actualizar panel si est√° abierto
    if (document.getElementById('infoPanel').classList.contains('open') && selectedNodeIndex === nodeIndex) {
      showNodeInfo(nodeIndex);
    }
  }

  // Actualizar t√≠tulo del nodo
  function updateNodeTitle(nodeIndex, title) {
    roadmap[nodeIndex].title = title;
    saveRoadmap();
    
    // Actualizar panel si est√° abierto
    if (document.getElementById('infoPanel').classList.contains('open') && selectedNodeIndex === nodeIndex) {
      document.getElementById('panelTitle').textContent = `Nodo ${nodeIndex + 1}: ${title}`;
    }
  }

  // Actualizar comentario del nodo
  function updateNodeComment(nodeIndex, comment) {
    roadmap[nodeIndex].comment = comment;
    saveRoadmap();
  }

  // Actualizar texto del tema
  function updateTopicText(nodeIndex, topicIndex, text) {
    roadmap[nodeIndex].topics[topicIndex].text = text;
    saveRoadmap();
  }

  // Alternar completado del tema
  function toggleTopicCompletion(nodeIndex, topicIndex) {
    roadmap[nodeIndex].topics[topicIndex].completed = 
      !roadmap[nodeIndex].topics[topicIndex].completed;
    saveRoadmap();
    updateProgress();
  }

  // Eliminar nodo
  function removeNode(nodeIndex) {
    if (confirm('¬øEst√°s seguro de que quieres eliminar este nodo?')) {
      roadmap.splice(nodeIndex, 1);
      
      // Cerrar panel si estaba abierto para este nodo
      if (selectedNodeIndex === nodeIndex) {
        closeInfoPanel();
        selectedNodeIndex = null;
      }
      
      saveRoadmap();
      
      if (currentView === 'diagram') {
        renderDiagram();
      } else {
        renderList();
      }
    }
  }

  // Mover nodo hacia arriba
  function moveNodeUp(nodeIndex) {
    if (nodeIndex === 0) return;
    [roadmap[nodeIndex], roadmap[nodeIndex - 1]] = 
      [roadmap[nodeIndex - 1], roadmap[nodeIndex]];
    saveRoadmap();
    
    if (currentView === 'diagram') {
      renderDiagram();
    } else {
      renderList();
    }
  }

  // Mover nodo hacia abajo
  function moveNodeDown(nodeIndex) {
    if (nodeIndex === roadmap.length - 1) return;
    [roadmap[nodeIndex], roadmap[nodeIndex + 1]] = 
      [roadmap[nodeIndex + 1], roadmap[nodeIndex]];
    saveRoadmap();
    
    if (currentView === 'diagram') {
      renderDiagram();
    } else {
      renderList();
    }
  }

  // Mostrar modal de importaci√≥n
  function showImportModal() {
    document.getElementById('importModal').style.display = 'flex';
  }

  // Cerrar modal de importaci√≥n
  function closeImportModal() {
    document.getElementById('importModal').style.display = 'none';
  }

  // Importar roadmap desde texto
  function importRoadmap() {
    const text = document.getElementById('importTextarea').value;
    if (!text.trim()) {
      alert('Por favor, ingresa un texto v√°lido');
      return;
    }
    
    const lines = text.split('\n');
    const newRoadmap = [];
    let currentNode = null;
    
    lines.forEach(line => {
      const trimmedLine = line.trim();
      
      // Nodo de inicio
      if (trimmedLine.startsWith('+ ') && !trimmedLine.toLowerCase().includes('final') && !trimmedLine.toLowerCase().includes('listo')) {
        if (currentNode) newRoadmap.push(currentNode);
        currentNode = {
          type: 'start',
          title: trimmedLine.substring(2).trim(),
          comment: '',
          topics: []
        };
      }
      // Nodo final
      else if (trimmedLine.startsWith('+ ') && (trimmedLine.toLowerCase().includes('final') || trimmedLine.toLowerCase().includes('listo'))) {
        if (currentNode) newRoadmap.push(currentNode);
        currentNode = {
          type: 'end',
          title: trimmedLine.substring(2).trim(),
          comment: '',
          topics: []
        };
      }
      // Nodo intermedio
      else if (trimmedLine.startsWith('- ') && !trimmedLine.startsWith('--')) {
        if (currentNode) newRoadmap.push(currentNode);
        currentNode = {
          type: 'intermediate',
          title: trimmedLine.substring(2).trim(),
          comment: '',
          topics: []
        };
      }
      // Comentario
      else if (trimmedLine.startsWith('# ')) {
        if (currentNode) {
          currentNode.comment = trimmedLine.substring(2).trim();
        }
      }
      // Tema
      else if (trimmedLine.startsWith('-- ')) {
        if (currentNode) {
          currentNode.topics.push({
            text: trimmedLine.substring(3).trim(),
            completed: false
          });
        }
      }
      // Conexi√≥n (ignorar por ahora)
      else if (trimmedLine.startsWith('!')) {
        // Las conexiones se ignoran en esta implementaci√≥n
      }
    });
    
    // A√±adir el √∫ltimo nodo
    if (currentNode) newRoadmap.push(currentNode);
    
    roadmap = newRoadmap;
    saveRoadmap();
    
    if (currentView === 'diagram') {
      renderDiagram();
    } else {
      renderList();
    }
    
    closeImportModal();
    alert('Ruta importada correctamente');
  }

  // Exportar roadmap a texto
  function exportRoadmap() {
    let exportText = '';
    
    roadmap.forEach(node => {
      // A√±adir nodo seg√∫n tipo
      if (node.type === 'start') {
        exportText += `+ ${node.title}\n`;
      } else if (node.type === 'end') {
        exportText += `+ ${node.title}\n`;
      } else {
        exportText += `- ${node.title}\n`;
      }
      
      // A√±adir comentario si existe
      if (node.comment) {
        exportText += `# ${node.comment}\n`;
      }
      
      // A√±adir temas
      node.topics.forEach(topic => {
        exportText += `-- ${topic.text}\n`;
      });
      
      exportText += '\n';
    });
    
    // Crear elemento temporal para copiar al portapapeles
    const textarea = document.createElement('textarea');
    textarea.value = exportText;
    document.body.appendChild(textarea);
    textarea.select();
    document.execCommand('copy');
    document.body.removeChild(textarea);
    
    alert('Ruta copiada al portapapeles');
  }

  // Validar roadmap
  function validateRoadmap() {
    const errors = [];
    
    // Verificar que hay al menos un nodo de inicio y uno de final
    const startNodes = roadmap.filter(node => node.type === 'start');
    const endNodes = roadmap.filter(node => node.type === 'end');
    
    if (startNodes.length === 0) {
      errors.push('No hay ning√∫n nodo de inicio');
    }
    
    if (endNodes.length === 0) {
      errors.push('No hay ning√∫n nodo final');
    }
    
    // Verificar que todos los nodos tienen t√≠tulo
    roadmap.forEach((node, index) => {
      if (!node.title.trim()) {
        errors.push(`El nodo ${index + 1} no tiene t√≠tulo`);
      }
    });
    
    // Mostrar resultados
    if (errors.length === 0) {
      alert('‚úÖ La ruta es v√°lida');
    } else {
      alert('‚ùå Se encontraron problemas:\n\n' + errors.join('\n'));
    }
  }

  // Cargar datos de ejemplo
  function loadSampleData() {
    roadmap = [
      {
        type: 'start',
        title: 'Fundamentos del An√°lisis de Datos',
        comment: 'Aplicar tema',
        topics: [
          { text: 'Subir', completed: false },
          { text: 'Bajar', completed: false },
          { text: 'Eliminar', completed: false }
        ],
        position: { x: 300, y: 200 }
      },
      {
        type: 'intermediate',
        title: 'Matem√°ticas y Estad√≠stica B√°sica',
        comment: 'Contexto para entender modelos y m√©tricas',
        topics: [
          { text: 'Estad√≠stica descriptiva (media, mediana, varianza, desviaci√≥n est√°ndar)', completed: false },
          { text: 'Probabilidad b√°sica (reglas, distribuciones comunes)', completed: false }
        ],
        position: { x: 500, y: 350 }
      },
      {
        type: 'end',
        title: '¬°Ruta Completada!',
        comment: 'Has adquirido los fundamentos del an√°lisis de datos',
        topics: [
          { text: 'Revisar todos los temas completados', completed: false },
          { text: 'Preparar proyecto final', completed: false }
        ],
        position: { x: 700, y: 200 }
      }
    ];
    
    saveRoadmap();
    renderDiagram();
  }
  </script>
</body>
</html>